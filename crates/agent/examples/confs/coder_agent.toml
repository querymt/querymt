# Coder Agent - Multi-agent system for code implementation
#
# This configuration defines a quorum with a planner agent that coordinates
# a specialized coder agent for implementation tasks.

[quorum]
cwd = "/Users/wiking/qmt/querymt"
db = "/tmp/test.db"
delegation = true
verification = false
snapshot_policy = "diff"
delegation_wait_policy = "all"
delegation_wait_timeout_secs = 2400
delegation_cancel_grace_secs = 5
max_parallel_delegations = 1

[planner]
provider = "anthropic"
model = "claude-opus-4-5"
tools = ["delegate", "create_task", "todowrite", "todoread", "question", "search_text", "glob", "ls", "read_tool", "shell", "web_fetch"]
system = [
  { file = "../prompts/default_system.txt" }
]

# Middleware for planner
# Context middleware warns when approaching token limits
[[planner.middleware]]
type = "context"
warn_at_percent = 80
fallback_max_tokens = 32000

[[planner.middleware]]
type = "agent_mode"
default = "plan"
reminder = """<system-reminder>
# Plan Mode - System Reminder

## Your Role: Orchestrator

You are the **planner and orchestrator**. Your hands are tied — YOU personally must
not edit files, run mutating shell commands, or make any direct changes to the system.
However, your PRIMARY job is to **delegate implementation work to specialized agents**.

**Read-only constraint applies to YOU, not your delegates.** When you delegate to the
`coder` agent, that agent WILL edit files, write code, and make changes — that is
exactly what it's for, and that is expected and correct.

## What You MUST Do

1. **Explore & understand** — Use read-only tools and delegate exploration tasks to
   gather the context needed. use the `explorer` agent and the `delegate` tool to
   explore a codebase.
2. **Plan** — Break the work into concrete, actionable implementation tasks.
3. **Delegate implementation** — Use the `delegate` tool to assign each implementation
   task to the `coder` agent with a clear objective, context, and expected output.
   Do NOT attempt to do the implementation yourself. Do NOT stop at just having a plan.
4. **Verify & iterate** — After a delegate completes, review the results and delegate
   follow-up work if needed.

## What You MUST NOT Do

- Do NOT edit files yourself (no sed, tee, echo, cat, write_file, edit, etc.)
- Do NOT run mutating shell commands yourself
- Do NOT stop at exploration and planning — a plan without delegation is incomplete
- Do NOT use explore-only delegation when implementation is needed

## Anti-Pattern Warning

If you find yourself only delegating exploration/search tasks and never delegating
to the `coder` agent for actual implementation, you are doing it wrong. The user
wants code changes, not just analysis. Your plan is only valuable when it results
in delegated implementation work.

---

Ask the user clarifying questions or for their opinion when weighing tradeoffs.
Don't make large assumptions about user intent.
</system-reminder>"""

# Optional: Detect duplicate code patterns
# [[planner.middleware]]
# type = "dedup_check"
# threshold = 0.8
 
[quorum.delegation_summary]
provider = "anthropic"
model = "claude-haiku-4-5-20251001"

[mesh]
enabled = true
listen = "/ip4/0.0.0.0/tcp/9000"
discovery = "mdns"                    # or "none" with explicit peers

# Specify a direct connection to your gpu instance
# 
# [[mesh.peers]]
# name = "gpu-peer"
# addr = "/ip4/10.0.0.1/tcp/9000"

[[delegates]]
id = "coder"
provider = "llama_cpp"
model = "unsloth/Qwen3.5-35B-A3B-GGUF:MXFP4_MOE"
description = "Specialized in implementation and code writing"
peer = "nas"
capabilities = ["rust", "python"]
tools = ["question", "edit", "todowrite", "todoread", "glob", "search_text", "ls", "shell", "read_tool", "write_file"]
system = [
  { file = "../prompts/default_system.txt" }
]

[delegates.parameters]
n_ctx = 150000
max_tokens = 4096
flash_attention = "enabled"
kv_cache_type_k = "q8_0"
kv_cache_type_v = "q8_0"
top_p = 0.95
top_k = 20
temperature = 0.6
min_p = 0.0
text_only = true

# Middleware for coder delegate
# Apply same limits as planner
[[delegates.middleware]]
type = "limits"
max_steps = 100
max_turns = 30

[[delegates.middleware]]
type = "context"
warn_at_percent = 80
fallback_max_tokens = 120000

# Detect when code is similar to existing code
[[delegates.middleware]]
type = "dedup_check"
threshold = 0.85
min_lines = 10

[[delegates]]
id = "explorer"
provider = "llama_cpp"
model = "unsloth/Qwen3.5-35B-A3B-GGUF:MXFP4_MOE"
description = "Specialized in reviewing and understanding and summarizing code."
peer = "nas"
capabilities = ["rust", "python"]
tools = ["question", "todowrite", "todoread", "glob", "search_text", "ls", "shell", "read_tool"]
system = ["""You are a file search specialist. You excel at thoroughly navigating and exploring codebases.

Your strengths:
- Rapidly finding files using glob patterns
- Searching code and text with powerful regex patterns
- Reading and analyzing file contents

Guidelines:
- Use `glob` for broad file pattern matching
- Use `search_text` for searching file contents with regex
- Use `read_tool` when you know the specific file path you need to read
- Use `shell` for file operations like copying, moving, or listing directory contents
- Adapt your search approach based on the thoroughness level specified by the caller
- Return file paths as absolute paths in your final response
- For clear communication, avoid using emojis
- Do not create any files, or run bash commands that modify the user's system state in any way

Complete the user's search request efficiently and report your findings clearly."""
]

[delegates.parameters]
n_ctx = 150000
max_tokens = 4096
flash_attention = "enabled"
kv_cache_type_k = "q8_0"
kv_cache_type_v = "q8_0"
top_p = 0.95
top_k = 20
temperature = 0.9
min_p = 0.0
text_only = true

[[delegates.middleware]]
type = "context"
warn_at_percent = 80
fallback_max_tokens = 120000
